import"./index-BDYN7ibo.js";import{V as u,a as V,b as M,l as Q,m as at,d as ht,n as ct,M as f,r as lt}from"./renderSettings-B9onYS4J.js";const mt=new u(1,1,1),L=(o,t,e)=>{if(o.z<-1||t.z<-1||o.z>1||t.z>1||o.x<-1&&t.x<-1||o.x>1&&t.x>1||o.y<-1&&t.y<-1||o.y>1&&t.y>1)return;o=e.viewportTransform(o),t=e.viewportTransform(t);let i=o.truncate(),n=t.truncate();const r=Math.abs(n.x-i.x),s=Math.abs(n.y-i.y),a=i.x<n.x?1:-1,h=i.y<n.y?1:-1;let m=r-s;for(;i.x>=0&&i.x<e.width&&i.y>=0&&i.y<e.height&&e.setPixel(i.x,i.y,mt),!(i.x===n.x&&i.y===n.y);){const d=2*m;d>-s&&(m-=s,i.x+=a),d<r&&(m+=r,i.y+=h)}},T=(o,t,e)=>(e.x-o.x)*(t.y-o.y)-(e.y-o.y)*(t.x-o.x),c=new M,l={u:0,v:0,w:0},S={u:0,v:0,w:0},dt=(o,t,e,i)=>{const n=e.viewportTransform(o[0]),r=e.viewportTransform(o[1]),s=e.viewportTransform(o[2]),a=1/T(s,r,n);if(a<=0||n.z<0||r.z<0||s.z<0||n.z>1||r.z>1||s.z>1||n.x<0&&r.x<0&&s.x<0||n.x>e.width&&r.x>e.width&&s.x>e.width||n.y<0&&r.y<0&&s.y<0||n.y>e.height&&r.y>e.height&&s.y>e.height)return;let h=~~Math.max(0,Math.min(n.x,r.x,s.x)),m=~~Math.max(0,Math.min(n.y,r.y,s.y)),d=~~Math.min(e.width,Math.max(n.x,r.x,s.x)),y=~~Math.min(e.height,Math.max(n.y,r.y,s.y));const x=new M(h,m);let $=T(s,r,x)*a,B=T(n,s,x)*a,O=T(r,n,x)*a;const R=new V(r.y-s.y,s.x-r.x).scaleInPlace(a),Y=new V(s.y-n.y,n.x-s.x).scaleInPlace(a),U=new V(n.y-r.y,r.x-n.x).scaleInPlace(a);for(c.y=m;c.y<=y;c.y++){for(l.u=$,l.v=B,l.w=O,c.x=h;c.x<=d;c.x++){if(l.u>=0&&l.v>=0&&l.w>=0){c.z=n.z*l.u+r.z*l.v+s.z*l.w;const k=c.x+c.y*e.width;if(c.z<i.data[k]){i.data[k]=c.z,c.w=1/(n.w*l.u+r.w*l.v+s.w*l.w),S.u=l.u*c.w*n.w,S.v=l.v*c.w*r.w,S.w=l.w*c.w*s.w,t.bc=S,t.fragPos=c;const _=t.fragment();_&&e.setPixel(c.x,c.y,_)}}l.u+=R.x,l.v+=Y.x,l.w+=U.x}$+=R.y,B+=Y.y,O+=U.y}};class tt{data;width;height;constructor(t,e){this.data=new Float32Array(t*e),this.width=t,this.height=e}clear(t){this.data.fill(t)}}class b{data;width;height;constructor(t,e,i){this.data=t,this.width=e,this.height=i}static Load=async(t,e=!1)=>{const i=new Image;i.src=t,await i.decode();const r=new OffscreenCanvas(i.width,i.height).getContext("2d");if(!r)throw new Error("Could not get texture context");r.drawImage(i,0,0);const s=r.getImageData(0,0,i.width,i.height),a=[];for(let h=0;h<s.data.length;h+=4)if(e){const m=new u(s.data[h]/255*2-1,s.data[h+1]/255*2-1,s.data[h+2]/255*2-1).normalize();a.push(m)}else a.push(new u(s.data[h]/255,s.data[h+1]/255,s.data[h+2]/255));return new b(a,i.width,i.height)}}class ut{width;height;totalPixels;data;constructor(t){this.width=t.width,this.height=t.height,this.totalPixels=this.width*this.height,this.data=t.data}setPixel=(t,e,i)=>{const n=(t+e*this.width)*4;this.data[n+0]=i.x*255,this.data[n+1]=i.y*255,this.data[n+2]=i.z*255};clear=()=>{this.data.fill(0);for(let t=3;t<this.totalPixels*4;t+=4)this.data[t]=255};viewportTransform=t=>{const e=(t.x+1)*(this.width*.5),i=(-t.y+1)*(this.height*.5);return new M(e,i,t.z,t.w)}}class D{vertexId=0;nthVert=0;bc={u:0,v:0,w:0};fragPos=new M;v2f=(t,e)=>{t[this.nthVert]=e};varying=()=>Array(3);interpolate=t=>t[0]*this.bc.u+t[1]*this.bc.v+t[2]*this.bc.w;interpolateVec2=t=>{const e=this.interpolate([t[0].x,t[1].x,t[2].x]),i=this.interpolate([t[0].y,t[1].y,t[2].y]);return new V(e,i)};interpolateVec3=t=>{const e=this.interpolate([t[0].x,t[1].x,t[2].x]),i=this.interpolate([t[0].y,t[1].y,t[2].y]),n=this.interpolate([t[0].z,t[1].z,t[2].z]);return new u(e,i,n)};interpolateVec4=t=>{const e=this.interpolate([t[0].x,t[1].x,t[2].x]),i=this.interpolate([t[0].y,t[1].y,t[2].y]),n=this.interpolate([t[0].z,t[1].z,t[2].z]),r=this.interpolate([t[0].w,t[1].w,t[2].w]);return new M(e,i,n,r)};toTexelCoord=(t,e,i)=>{const n=Math.max(0,Math.min(e-1,~~(t.x*e))),r=Math.max(0,Math.min(i-1,~~((1-t.y)*i)));return{x:n,y:r}};sample=(t,e)=>{const i=this.toTexelCoord(e,t.width,t.height),n=i.x+i.y*t.width;return t.data[n].clone()};sampleDepth=(t,e)=>{const i=this.toTexelCoord(e,t.width,t.height),n=i.x+i.y*t.width;return t.data[n]}}const wt=.25,xt=16,gt=.1,ft=.8;class pt extends D{uniforms;vNormal=this.varying();vWorldPos=this.varying();vertex=()=>{const t=this.uniforms.model,e=this.vertexId,i=this.uniforms.modelMat.multiplyPoint(t.vertices[e]),n=this.uniforms.normalMat.multiplyDirection(t.normals[e]).normalize();return this.v2f(this.vNormal,n),this.v2f(this.vWorldPos,i),this.uniforms.mvp.multiplyPoint(t.vertices[e])};fragment=()=>{const t=this.interpolateVec3(this.vNormal).normalize(),e=this.interpolateVec4(this.vWorldPos),n=this.uniforms.camPos.subtract(e.xyz).normalize().subtract(this.uniforms.lightDir).normalize();let r=Math.pow(Math.max(t.dot(n),0),xt);r*=wt;const a=Math.max(-t.dot(this.uniforms.lightDir),0)+r+gt;return this.uniforms.lightCol.scale(a*ft)}}const yt=.25,vt=16,Pt=.1;class Mt extends D{uniforms;vNormal=this.varying();vWorldPos=this.varying();vUV=this.varying();vertex=()=>{const t=this.uniforms.model,e=this.vertexId,i=this.uniforms.modelMat.multiplyPoint(t.vertices[e]),n=this.uniforms.normalMat.multiplyDirection(t.normals[e]).normalize();return this.v2f(this.vNormal,n),this.v2f(this.vWorldPos,i),this.v2f(this.vUV,t.uvs[e]),this.uniforms.mvp.multiplyPoint(t.vertices[e])};fragment=()=>{const t=this.interpolateVec3(this.vNormal).normalize(),e=this.interpolateVec4(this.vWorldPos),i=this.interpolateVec2(this.vUV),n=this.sample(this.uniforms.texture,i),s=this.uniforms.camPos.subtract(e.xyz).normalize().subtract(this.uniforms.lightDir).normalize();let a=Math.pow(Math.max(t.dot(s),0),vt);a*=yt;const h=Math.max(-t.dot(this.uniforms.lightDir),0),m=this.uniforms.lightCol.scale(h+a+Pt);return n.multiplyInPlace(m)}}const zt=.25,Dt=16,Tt=.1,St=.8;class It extends D{uniforms;lighting=0;vertex=()=>{const t=this.uniforms.model,e=this.vertexId,i=this.uniforms.normalMat.multiplyDirection(t.faceNormals[e]).normalize(),n=this.uniforms.mvp.multiplyPoint(t.vertices[e]),s=this.uniforms.camPos.subtract(n.xyz).normalize().subtract(this.uniforms.lightDir).normalize();let a=Math.pow(Math.max(i.dot(s),0),Dt);a*=zt;const h=Math.max(-i.dot(this.uniforms.lightDir),0);return this.lighting=(h+a+Tt)*St,this.uniforms.mvp.multiplyPoint(t.vertices[e])};fragment=()=>this.uniforms.lightCol.scale(this.lighting)}class Vt extends D{uniforms;vertex=()=>this.uniforms.lightSpaceMat.multiplyPoint(this.uniforms.model.vertices[this.vertexId]);fragment=()=>{}}const Ct=1e-4,Et=.25,bt=16,Lt=.1;class Nt extends D{uniforms;vUV=this.varying();vLightSpacePos=this.varying();vLightDirTangent=this.varying();vViewDirTangent=this.varying();vertex=()=>{const t=this.uniforms.model,e=this.vertexId,i=t.normals[e],n=t.tangents[e],r=t.bitangents[e],s=t.vertices[e],a=new u(n.dot(this.uniforms.mLightDir),r.dot(this.uniforms.mLightDir),i.dot(this.uniforms.mLightDir)),h=this.uniforms.mCamPos.subtract(s).normalize(),m=new u(n.dot(h),r.dot(h),i.dot(h)),d=this.uniforms.lightSpaceMat.multiplyPoint(s);return d.x=d.x*.5+.5,d.y=d.y*.5+.5,this.v2f(this.vUV,t.uvs[e]),this.v2f(this.vLightSpacePos,d),this.v2f(this.vLightDirTangent,a),this.v2f(this.vViewDirTangent,m),this.uniforms.mvp.multiplyPoint(s)};fragment=()=>{const t=this.interpolateVec2(this.vUV),e=this.interpolateVec4(this.vLightSpacePos),i=this.interpolateVec3(this.vLightDirTangent).normalize(),n=this.interpolateVec3(this.vViewDirTangent).normalize(),r=this.sampleDepth(this.uniforms.shadowMap,e),s=e.z-Ct>r?0:1,a=this.sample(this.uniforms.texture,t),h=this.sample(this.uniforms.normalTexture,t),m=n.subtract(i).normalize();let d=Math.pow(Math.max(h.dot(m),0),bt);d*=Et;const y=Math.max(-h.dot(i),0),x=this.uniforms.lightCol.scale((y+d)*s+Lt);return a.multiplyInPlace(x)}}const At=800,Wt=600,Ft=5,j=250,H=250,X=100,w=document.getElementById("canvas"),$t=document.getElementById("fps"),Bt=document.getElementById("tris"),et=document.getElementById("orthoCb"),N=document.getElementById("shadingDd"),K=document.getElementById("fileInput"),it=w.getContext("2d");if(!it)throw new Error("Could not get canvas context");w.width=At;w.height=Wt;const A=w.width/w.height,nt=new ImageData(w.width,w.height),v=new ut(nt),q=new tt(w.width,w.height),W=new tt(w.width,w.height),I=new u(0,-1,1).normalize(),Ot=new u(1,1,1),C=new u(0,0,-2.5);let P=1.5,p=Q(at,!0),F=await b.Load(ht),ot=await b.Load(ct,!0),E=new u(0,0,0),z=new u(0,-Math.PI/2,0),Rt=new u(1,1,1);const Yt={normalMapped:new Nt,textured:new Mt,smooth:new pt,flat:new It},G=new Vt,g=[],st=()=>{Bt.innerText=(p.vertices.length/3).toFixed(0)},Ut=()=>{z.set(0,-Math.PI/2,0),E.set(0,0,0)},kt=()=>{const o=lt(N.value,F.data.length>0&&p.uvs.length>0);return o.normalizedValue!==N.value&&(N.value=o.normalizedValue),{shaderKey:o.material,wireframe:o.wireframe,useShadows:o.useShadows}},Z=(o,t,e=!1)=>{for(let i=0;i<p.vertices.length;i+=3){for(let n=0;n<3;n++)o.vertexId=i+n,o.nthVert=n,g[n]=o.vertex();if(e){L(g[0],g[1],v),L(g[1],g[2],v),L(g[2],g[0],v);continue}dt(g,o,v,t)}},_t=o=>{z.y-=o/Ft},jt=()=>{v.clear(),q.clear(1e3),W.clear(1e3);const o=kt(),t=f.TRS(E,z,Rt),e=t.invert(),i=t.invert().transpose(),n=f.LookTo(I.scale(-5),I,u.Up),r=f.Ortho(P,A),s=t.multiply(n.multiply(r)),a=e.multiplyDirection(I).normalize(),h=e.multiplyPoint(C).xyz,m=f.LookTo(C,u.Forward,u.Up),d=et.checked?f.Ortho(P,A):f.Perspective(60,A),y=t.multiply(m).multiply(d),x=Yt[o.shaderKey];G.uniforms={model:p,lightSpaceMat:s},x.uniforms={model:p,modelMat:t,mvp:y,normalMat:i,lightDir:I,mLightDir:a,lightCol:Ot,camPos:C,mCamPos:h,texture:F,normalTexture:ot,lightSpaceMat:s,shadowMap:W},o.useShadows&&Z(G,W),Z(x,q,o.wireframe),it.putImageData(nt,0,0)};let J=0;const rt=()=>{const o=performance.now(),t=(o-J)/1e3;J=o,_t(t),jt();const e=performance.now()-o;$t.innerText=e.toFixed(0),requestAnimationFrame(rt)};w.onmousemove=o=>{o.buttons===1?(z.y-=o.movementX/j,z.x+=o.movementY/j):(o.buttons===2||o.buttons===4)&&(E.x+=o.movementX/H,E.y-=o.movementY/H)};w.onwheel=o=>{o.preventDefault(),et.checked?(P+=o.deltaY/X,P=Math.max(.01,P)):C.z-=o.deltaY/X};w.oncontextmenu=o=>o.preventDefault();K.onchange=async()=>{const o=K.files?.[0];if(!o)return;const t=await o.text();p=Q(t,!0),F.data=[],ot.data=[],st(),Ut()};st();rt();
